<!doctype html>
<html>
  <head>
    <meta charset="UTF-8"/>
  </head>
  <link rel="stylesheet" href="highlight/styles/github-dark.min.css">
  <style>
    code{
      background-color:#D3D3D3;
    }
    .center{
      margin-left:auto;
      margin-right:auto;
      display:block;
    }
    .hr1{
        height:0.5em;background-color:lightgrey;
    }
    .dimdiv{
      position:absolute;
      top:0;
      width:100%;
      pointer-events: none;
    }
    .dimcode{
      background-color:black;
      opacity:0.625;
      width:100%;
      display:block;
    }
    .showcode{
      width:100%;
      opacity:0;
      display:block;
    }
    .readborder{
      border:0.25em solid black;
    }
    .copyborder{
      border:0.5em dashed gray;
    }
    .codeParentDiv{
      position:relative;
      overflow-x:scroll;
    }
  </style>
  <body>
    <table style="position:fixed;top:0%;left:0%;width:auto;height:100%;background-color:lightgrey">
      <tr>
        <td style="border: 1px solid black;">
          <span><b>Attention:</b>Repository : <a href="https://github.com/shuffleandko/circle-collision-without-vector">https://github.com/shuffleandko/circle-collision-without-vector</a>. The correctness of this tutorial is not guaranteed, the context may be updated without notifications, and the author is not responsible for any consequences that copy or run the codes in the tutorial, if any.</span>
          <hr/>
          <span><b>Go to chapter: </b></span>
          <select onChange="window.location.href=this.value">
            <option value="chapter_1.html">Chapter 1 : Introduction</option>
            <option value="chapter_2.html">Chapter 2 : Draw something on browsers using canvas element</option>
            <option value="chapter_3.html">Chapter 3 : Move the circle</option>
            <option value="chapter_4.html">Chapter 4 : Circle-circle collision detection</option>
            <option value="chapter_5.html" selected disabled>Chapter 5 : Circle-circle collision response</option>
            <option value="chapter_6.html">Chapter 6 : Use array to avoid repeating codes</option>
            <option value="chapter_7.html">Chapter 7 : Circles and fixed circles collision</option>
            <option value="chapter_8.html">Chapter 8 : Circles and fixed points, lines and fixed polygons collision</option>
            <option value="chapter_9.html">Chapter 9 : Test all objects working together and remove debug drawings</option>
          </select>
          <hr/>
          <button onclick="window.location.href='#top'">▲ Go back to top ▲</button>&nbsp<span><b>Move to section</b>:
            <select onChange="window.location.href=this.value">
              <option value="#section_1">5.1 Prepare the example code</option>
              <option value="#section_2">5.2 Add mass property to circles</option>
              <option value="#section_3">5.3 Print vx and vy on the canvas for debugging</option>
              <option value="#section_4">5.4 Circle-circle collision response at 1D dimension : Apply the elastic collision formula directly</option>
              <option value="#section_5">5.5 Circle-circle collision response at 1D dimension : Reduce to the case that one of the circles doesn't move</option>
              <option value="#section_6">5.6 Avoid 'separate collision' (circles stick together) : avoid apply collision formulae when 2 circles are separating instead of colliding</option>
              <option value="#section_7">5.7 Circle-circle collision response at 2D dimension, but at a horizontal line : Basic scenario of 2D collision</option>
              <option value="#section_8">5.8 Circle-circle collision response at 2D dimension : circles at any position, vx and vy</option>
              <option value="#section_9">5.9 Verify the result : calculate the total energy before and after collison</option>
              <option value="#section_10">5.10 Refactor the code : eliminate the square root</option>
            </select>
          </span>
        </td>
      </tr>
      <tr style="width:width:100%;height:100%;">
        <td style="width:100%;height:100%;"><div style="background-color:white;overflow-x:auto;overflow-y:scroll;width:width:100%;height:100%;padding-left:0.5em;">
          <div id="top"></div> 
    <h1 style="text-align:center;">Chapter 5 : Circle-circle collision response</h1>
    <hr class="hr1"/>
    <h2 id="section_1">5.1 Prepare the example code</h2>
    <p>At former chapter, we implemented collision detection between 2 circles. However, the core of "physics engine" is to simulate the collision : give circles new <code>vx</code> and <code>vy</code> after collision! So in this chapter we will write the code that calculates and applies the new velocity of 2 circles after collision. Recall the example at last chapter:</p>
    <div class="codeParentDiv" style="height:65em"><div class="hljs copyborder" style="position:absolute;">
        <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:20,
    cy:50,
    r:30,
    vx:60,
    vy:30
  };

  const c2={
    cx:150,
    cy:100,
    r:20,
    vx:-10,
    vy:-20
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  const frameRate=60;
  const intervalId=setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
    </div></div>
    <p>The code should show 2 circles collide and then stop as the following:</p>
    <iframe id="iframe-chapter_5_1_1-1" class="center" src="chapter_5_1_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_1_1-1').src+='';">Reload</button>
    <p>So in this chapter, we would continue building the physics engine base on the code above.</p>
    <hr class="hr1"/>
    <h2 id="section_2">5.2 Add mass property to circles</h2>
    <p>Before applying formula to calculate the velocity of rebound after collision, the circles need to add a new but very important property : <b>mass</b> (we would name the property as <code>m</code> in the code)! Mass is the measure of inertia, or just call it "how heavy of a circle" at here if you don't like the formal physics definitions! The mass of circle determines the rebound velocity after colliding. </p>
    <p>Although we may have a small circle with very great mass or a big circle but very small mass, we would like to visualize the collision effect in more straightforward way : lighter circle would rebound with faster velocity, so we would set the mass of the circles as equal to its area numerically, for example: for a circle that radius is <b>10</b>, applying the formula of circle area <b>πr<sup>2</sup></b>, its mass would be <code>Math.PI*10*10</code>.</p>
    <p>Now add the property <code>m</code> to the circle, which is the mass, and <b>set the mass as the area of the circle</b>:</p>
    <div class="codeParentDiv" style="height:66em"><div class="hljs copyborder" style="position:absolute;">
        <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl"> const c1={
    cx:20,
    cy:50,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:60,
    vy:30
  };
  
  const c2={
    cx:150,
    cy:100,
    r:20,
    m:Math.PI*20*20, //mass = area
    vx:-10,
    vy:-20
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  const frameRate=60;
  const intervalId=setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>      
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p><b>Note :</b> We <b>CANNOT</b> set the <code>m</code> of <code>c1</code> inside the object definition like the following:</p>
    <div class="codeParentDiv" style="height:11em"><div class="hljs readborder" style="position:absolute;"><pre><code><span class="hl">const c1={
  cx:20,
  cy:50,
  r:30,
  m:c1.r*30*30, //mass = area
  vx:60,
  vy:30
};</span></code></pre></div></div>
    <p>because <code>c1</code> is still not initialized inside the object definition!</p>
    <p>So, the newly add property : <code>m</code> (mass), still has no effect currently and the canvas should show the same thing as last example, but now the code above is ready for us to implement collision response later!</p>
    <hr class="hr1"/>
    <h2 id="section_3">5.3 Print vx and vy on the canvas for debugging</h2>
    <p>Unlike positions, velocity is harder to estimate and unable to be seen on the screen directly, so we would add codes that print the velocity of the circles on the canvas in order to debug. Also we need to know the which circle we are talking about when applying maths formulae, so we would label "C1" and "C2" for 2 circles on the canvas. Modify the code, add a dot at the center of circle and also the text drawing code as the following:</p>
    <div class="codeParentDiv" style="height:81em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:20,
    cy:50,
    r:30,
    vx:60,
    vy:30
  };

  const c2={
    cx:150,
    cy:100,
    r:20,
    vx:-10,
    vy:-20
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  const intervalId=setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>   
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>    
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>     
        </div>
    </div></div>
    <p>First we need to set the font size and align of the text because the default font is too small:</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">ctx.font="12px sans-serif";
ctx.textAlign="center";</span></code></pre>
    </div></div>
    <p>Here we add the code that shows the center of the circle:</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);</span></code></pre>
    </div></div>
    <p>with <code>vx</code> and <code>vy</code> under the center:</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);</span></code></pre>
    </div></div>
    <p>Note that instead of showing the exact value of <code>vx</code> and <code>vy</code>, we added <code>toFixed(1)</code> to round them to 1 decimal place because at later, <code>vx</code> and <code>vy</code> may have many decimals because of result from division and hence round them to have better visual presentation. The actual value used internally was not rounded by <code>toFixed(1)</code>.</p>
    <p>Now the circle shows its <code>vx</code> and <code>vy</code> under the center as the following:</p>
    <iframe id="iframe-chapter_5_3_1-1" class="center" src="chapter_5_3_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_3_1-1').src+='';">Reload</button>
    <p>Now, we may start implementating actual collision response codes!</p>
    <hr class="hr1"/>
    <h2 id="section_4">5.4 Circle-circle collision response at 1D dimension : Apply the elastic collision formula directly</h2>
    <p>Before moving to 2D collision (2 circles come from any angles and velocities), we would start implementating 1D collision response, which 2 circles lie on x axis and <code>vy</code> of both are <b>0</b>. So, we start with 2 circles different from the example above: set <code>cy</code> and <code>vy</code> as <b>0</b>, also change the <code>cx</code>, <code>r</code>, <code>m</code> and <code>vx</code>:</p>
    <p>Circle 1 (C1):</p>
    <ul>
      <li>cx : 100</li>
      <li>cy : 0 </li>
      <li>r : 50 </li>
      <li>m : π50<sup>2</sup></li>
      <li>vx : 20</li>
      <li>vy : 0</li>
    </ul>
    <p>Circle 2 (C2):</p>
    <ul>
      <li>cx : -100</li>
      <li>cy : 0 </li>
      <li>r : 30 </li>
      <li>m : π30<sup>2</sup></li>
      <li>vx : -60</li>
      <li>vy : 0</li>
    </ul>
    <p>Modify the code to set the new properties of 2 circles:</p>
    <div class="codeParentDiv" style="height:80em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-100,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:20,
    vy:0
  };
  
  const c2={
    cx:100,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-60,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  const intervalId=setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    if(Math.sqrt((c2.cx-c1.cx)*(c2.cx-c1.cx)+(c2.cy-c1.cy)*(c2.cy-c1.cy)) <= c1.r+c2.r){ //find if d is smaller than (or equals to) r1+r2
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>    
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>Now there are 2 circles moving along x axis, when they collide, they stop immediately:</p>
    <iframe id="iframe-chapter_5_4_1-1" class="center" src="chapter_5_4_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_4_1-1').src+='';">Reload</button>
    <p>Now we would implement collision response code! We would implement <b>elastic collison</b> : no energy lost after collision (instead of <b>inelastic collision</b>), because <b>elastic collison</b> is simpler to implement for our physics engine.</p>
    <p>First, we would consider 2 formulae for <b>elastic collison</b>:</p>
    <ul>
      <li>M<sub>a</sub>V<sub>aOld</sub>+M<sub>2</sub>V<sub>bOld</sub>=M<sub>a</sub>V<sub>aNew</sub>+M<sub>2</sub>V<sub>bNew</sub></li>
      <li><sup>1</sup>/<sub>2</sub>M<sub>a</sub>V<sub>aOld</sub><sup>2</sup>+<sup>1</sup>/<sub>2</sub>M<sub>2</sub>V<sub>bOld</sub><sup>2</sup>=<sup>1</sup>/<sub>2</sub>M<sub>a</sub>V<sub>aNew</sub><sup>2</sup>+<sup>1</sup>/<sub>2</sub>M<sub>2</sub>V<sub>bNew</sub><sup>2</sup></li>
    </ul>
    <p>Where <b>a</b> is circle 1 (C1) and <b>b</b> is circle 2 (C2). After collision, the new <code>vx</code> of circle 1 (C1) is <b>V<sub>aNew</sub></b> while new <code>vx</code> of circle 2 (C2) is <b>V<sub>bNew</sub></b>. By rewriting the formula in terms of <b>V<sub>aNew</sub></b> and <b>V<sub>bNew</sub></b>, the formula we need is:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>aNew</sub></b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>a</sub>-M<sub>b</sub>)*V<sub>aOld</sub>+2*M<sub>b</sub>*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>bNew</sub></b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>b</sub>-M<sub>a</sub>)*V<sub>bOld</sub>+2*M<sub>a</sub>*V<sub>aOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <p>Recall the new circle properties (we may ignore other properties other than <code>m</code> and <code>vx</code> because 1D collision is related to these 2 properties only):<p>
    <p>Circle 1 (C1):</p>
    <ul>
      <li>m : π50<sup>2</sup></li>
      <li>vx : 20</li>
    </ul>
    <p>Circle 2 (C2):</p>
    <ul>
      <li>m : π30<sup>2</sup></li>
      <li>vx : -60</li>
    </ul>
    <p>We may calculate the new vx of 2 circles are:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>c1.vx</b> = V<sub>aNew</sub> = </td>
        <td style="border-bottom:1px solid;">(π50<sup>2</sup>-π30<sup>2</sup>)*20+2*π30<sup>2</sup>*-60</td>
        <td rowspan="2"> = -22.4 (rounded to 1 decimal)</td>
      </tr>
      <tr>
        <td>π30<sup>2</sup>+π50<sup>2</sup></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>c2.vx</b> = V<sub>bNew</sub> = </td>
        <td style="border-bottom:1px solid;">(π30<sup>2</sup>-π50<sup>2</sup>)*-60+2*π50<sup>2</sup>*20</td>
        <td rowspan="2"> = 57.6 (rounded to 1 decimal)</td>
      </tr>
      <tr>
        <td>π30<sup>2</sup>+π50<sup>2</sup></td>
      </tr>
    </table>
    <p>So we would convert the variables in the formula to the object properties that we are using:</p>
    <div class="codeParentDiv" style="height:7em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const new_c1vx = ((c1.m - c2.m) * c1.vx + 2 * c2.m * c2.vx) / (c1.m + c2.m); //apply collision formula directly
c2.vx = ((c2.m - c1.m) * c2.vx + 2 * c1.m * c1.vx) / (c1.m + c2.m);
c1.vx = new_c1vx;</span></code></pre>
    </div></div>
    <p>Note that we need to introduce a new variable <code>new_c1vx</code> to hold the new <code>c1.vx</code> first because <code>c2.vx</code> needs original <code>c1.vx</code> to calculate.</p>
    <p>We would add the collision formula to the code as the following:</p>
    <div class="codeParentDiv" style="height:84em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-100,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:20,
    vy:0
  };
  
  const c2={
    cx:100,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-60,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const c1_vx_new = ((c1.m - c2.m) * c1.vx + 2 * c2.m * c2.vx) / (c1.m + c2.m); //apply collision formula directly
      c2.vx = ((c2.m - c1.m) * c2.vx + 2 * c1.m * c1.vx) / (c1.m + c2.m);
      c1.vx = c1_vx_new;
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code> 
          <code class="showcode">&nbsp;</code>              
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>The code above should show 2 circles separate after colliding:<p>
    <iframe id="iframe-chapter_5_4_2-1" class="center" src="chapter_5_4_2.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_4_2-1').src+='';">Reload</button>
    <p>Now it shows something similar to normal collision response : circle 1 (C1) moves with <code>vx</code> = <b>-22.4</b>, and circle 2 (C2) <code>vx</code> becomes <b>57.6</b>.</p>
    <p>Congratulations! You implemented the core of the physics engine : collision response! Although it is just circles at 1D, it can help us to implement the 2D collision by reducing the collision scenario to 1D collision later.</p>
    <hr class="hr1"/>
    <h2 id="section_5">5.5 Circle-circle collision response at 1D dimension : Reduce to the case that one of the circles doesn't move</h2>
    <p>While we can apply the collision formula above directly to simulate the collision, we may use another simpler way to calculate the new <code>vx</code> : Reduce to the case that one circle doesn't move at all! What does it mean?</p>
    <p>Consider the example above, the original <code>vx</code> of circle 1 (C1) is <b>20</b>px per second, now we move the canvas at <b>-20</b>px per second to compensate the movement of circle 1 (C1), resulting as if circle 1 (C1) not moving at all, then the <code>vx</code> of circle 1 (C1) in reduced case, called <b>relative <code>vx</code></b>, becomes <b>-60 - 20 = -80</b>, shown as below:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Original case</th>
      <th>Whole canvas moving with vx -20px / s</th>
      <th>Case that equivalent to moving canvas</th>
      <tr>
        <td>
          <iframe id="iframe-chapter_5_4_2-2" class="center" src="chapter_5_4_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_5_1-1" class="center" src="chapter_5_5_1.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_5_2-1" class="center" src="chapter_5_5_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_4_2-2').src+='';document.getElementById('iframe-chapter_5_5_1-1').src+='';document.getElementById('iframe-chapter_5_5_2-1').src+='';">Reload</button>
    <p>Now the original example is reduced to the case that circle 1 (C1) doesn't move, and the apparent <code>vx</code> of circle 2 (C2) also changed to <b>-80</b>. Then we are going to calculate the new <code>vx</code> of circle 2 (C2) at the <b>reduced case</b>:</p>
    <p>Circle 1 (C1):</p>
    <ul>
      <li>m : π50<sup>2</sup></li>
      <li>vx : 20 - 20 = 0</li>
    </ul>
    <p>Circle 2 (C2):</p>
    <ul>
      <li>m : π30<sup>2</sup></li>
      <li>vx : -60 - 20 = -80</li>
    </ul>
    <p>Recall the collision formulae:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>aNew</sub></b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>a</sub>-M<sub>b</sub>)*V<sub>aOld</sub>+2*M<sub>b</sub>*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>bNew</sub></b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>b</sub>-M<sub>a</sub>)*V<sub>bOld</sub>+2*M<sub>a</sub>*V<sub>aOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <p>As <code>vx</code> of circle 1 (C1), <b>V<sub>aOld</sub></b>, is <b>0</b> this time, the formulae can be simplified as:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>aNew</sub> (reduced case)</b> = </td>
        <td style="border-bottom:1px solid;">2*M<sub>b</sub>*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>bNew</sub> (reduced case)</b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>b</sub>-M<sub>a</sub>)*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <p>By applying the formulae to the reduced case, we may find the new <code>vx</code> at the reduced case as the following:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>c1.vx</b> = V<sub>aNew</sub> (reduced case) = </td>
        <td style="border-bottom:1px solid;">2*π30<sup>2</sup>*-80</td>
        <td rowspan="2"> = -42.4 (rounded to 1 decimal)</td>
      </tr>
      <tr>
        <td>π50<sup>2</sup>+π30<sup>2</sup></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>c2.vx</b> = V<sub>bNew</sub> (reduced case) = </td>
        <td style="border-bottom:1px solid;">(π30<sup>2</sup>-π50<sup>2</sup>)*-80</td>
        <td rowspan="2"> = 37.6 (rounded to 1 decimal)</td>
      </tr>
      <tr>
        <td>π50<sup>2</sup>+π30<sup>2</sup></td>
      </tr>
    </table>
    <p>As a reminder, we are calculating the new <code>vx</code> at the following reduced case:</p>
    <iframe id="iframe-chapter_5_5_2-2" class="center" src="chapter_5_5_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_5_2-2').src+='';">Reload</button>
    <p>So, this time, we calculated the <code>vx</code> under the reduced case. But we need to find <code>vx</code> in original case, right? How can the reduced case help us to find <code>vx</code> in original case? The answer is : <b>Add back 20 (<code>vx</code> of circle 1 (C1) before collision) to both circles</b>! As the reduced case we move the canvas at velocity <code>-c1.vx</code>, when we restore to the reduced case to the original case, we add back <code>c1.vx</code> for 2 both circles at reduced case, resulting reverting to the original case. So the actual <code>vx</code> is:</p>
    <ul>
      <li>c1.vx = <b>c1.vx (reduced case) + original c1.vx</b> = -42.4 + (20) = -22.4</li>
      <li>c2.vx = <b>c2.vx (reduced case) + original c1.vx</b> = 37.6 + (20) = 57.6</li>
    </ul>
    <p>When we add back the original <code>c1.vx</code>, that is the original case as the following:</p>
    <iframe id="iframe-chapter_5_4_2-3" class="center" src="chapter_5_4_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_4_2-3').src+='';">Reload</button>
    <p>The new <code>vx</code> in the reduced case is the same as calculating by applying the formula directly, but with shorter formula!</p>
    <p>So the flow to calculate the new <code>vx</code> with "reducing case" method is:</p>
    <ol>
      <li>Reduce to the case that circle 1 (C1) is not moving, then <code>vx</code> of circle 2 (C2), called <b>relative <code>vx</code></b>, becomes <code>c2.vx-c1.vx</code></li>
      <li>Find <code>vx</code> of both circles at the reduced case with simplified formulae</li>
      <li>Add back <code>c1.vx</code> (original <code>vx</code> of circle 1 (C1) ) to the <code>vx</code> calculated at reduced case</li>
    </ol>
    <p>So the steps to construct the codes would be:</p>
    <p>1. Reduce to the case that circle 1 (C1) is not moving, then we have the <code>vx</code> of circle 1 (C1) at the reduced case : <code>rel_vx</code> (<b>relative <code>vx</code></b>):</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">const rel_vx = c2.vx - c1.vx; //1</span></code></pre>
    </div></div>
    <p>2. Find new <code>vx</code> of 2 circles at the reduced case:</p>
    <div class="codeParentDiv" style="height:7em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_vx = c2.vx - c1.vx; //1
const new_c1vx = 2 * c2.m * rel_vx / (c1.m + c2.m); //2
const new_c2vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m); //2 </span></code></pre>
  </div></div>
  <p>3. Add back the original <code>c1.vx</code> (<code>vx</code> of circle 1 (C1) before collision) to the new <code>vx</code> calculated from (2):</p>
  <div class="codeParentDiv" style="height:9em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_vx = c2.vx - m1.vx; //1
const new_c1vx = 2 * c2.m * rel_vx / (c1.m + c2.m); //2 , update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
const new_c2vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m); //2 
c2.vx = new_c2vx + c1.vx; //3
c1.vx = new_c1vx + c1.vx; //3</span></code></pre>
  </div></div>
  <p><b>Note : Here we need to update <code>c2.vx</code> first because <code>c1.vx</code> would be modified later, which calculating new <code>c1.vx</code> needs <code>c1.vx</code> before collision</b></p>
  <p>Simplify the code by eliminating <code>new_c1vx</code> and <code>new_c2vx</code>:<p>
  <div class="codeParentDiv" style="height:7em"><div class="hljs copyborder" style="position:absolute;">
    <pre><code><span class="hl">const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx;
c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;</span></code></pre>
  </div></div>
    <p>Let's use the new collision formulae! Replace the old formulae with the code above as the following:</p>
    <div class="codeParentDiv" style="height:85em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-100,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:20,
    vy:0
  };
  
  const c2={
    cx:100,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-60,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx = c2.cx - c1.cx;
    const dy = c2.cy - c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
      c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>              
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>When we run the code above, it should look identical to the canvas that applies the collision formulae directly:</p>
    <iframe id="iframe-chapter_5_5_3-1" class="center" src="chapter_5_5_3.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_5_3-1').src+='';">Reload</button>
    <p>Lets compare 2 versions different formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Apply collision formula directly</th>
      <th>Reduced case with simplified formula</th>
      <tr>
        <td>
          <iframe id="iframe-chapter_5_4_2-4" class="center" src="chapter_5_4_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_5_3-2" class="center" src="chapter_5_5_3.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_4_2-4').src+='';document.getElementById('iframe-chapter_5_5_3-2').src+='';">Reload</button>
    <p>Seems no difference, right?</p>
    <p>So, you may ask, "reduce case" method seems identical to the case that using direct formula, and take more steps to calculate, why do we need that? The answer is : <b>it can simplify the 2D collision alot later</b>!</p>
    <hr class="hr1"/>
    <h2 id="section_6">5.6 Avoid 'separate collision' (circles stick together) : avoid apply collision formulae when 2 circles are separating instead of colliding</h2>
    <p>While our 1D collision canvas seems looks fine currently, there may have some situations that 2 circles stick together after colliding instead of separating. Consider the cases that initially 2 circles are already touching together. Modify the circle position and set <code>vx</code> of both as 0 so that they are touching initially but not moving as the following:</p>
    <div class="codeParentDiv" style="height:84em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:0,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:0,
    vy:0
  };
  
  const c2={
    cx:79,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:0,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx = c2.cx - c1.cx;
    const dy = c2.cy - c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
      c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>        
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>        
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>        
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>        
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>The canvas should show 2 static circles the following:</p>
    <iframe class="center" src="chapter_5_6_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>It looks normal, right? Now modify the <code>vx</code> of circle 2 (C2), set it as <b>-80</b>:</p>
    <div class="codeParentDiv" style="height:84em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:0,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:0,
    vy:0
  };
  
  const c2={
    cx:79,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-80,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx = c2.cx - c1.cx;
    const dy = c2.cy - c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
      c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>What will happen? 2 circles separate immediately? No! They would <b>stick together</b> for some time before leaving the screen:</p>
    <iframe id="iframe-chapter_5_6_2-1" class="center" src="chapter_5_6_2.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_6_2-1').src+='';">Reload</button>
    <p>Why would that happen? <b>Because 2 circles are not fully separated after collision, then the code also applies collision formulae to the case that both circles are separating (separate collision)!</b></p>
    <p>Let's reduce the frame rate from <code>1000/frameRate</code> to <code>1000</code> (1 second for each frame) to see what is happening:</b></p>
    <iframe id="iframe-chapter_5_6_3-1" class="center" src="chapter_5_6_3.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_6_3-1').src+='';">Reload</button>
    <p>The current situation:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Frame 1</th>
      <th>Frame 2</th>
      <th>Frame 3</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_6_4.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_5.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_6.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
          </ul>
          Apply collision, result:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
          Apply collision, result:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
          </ul>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
          </ul>
          Apply collision, result:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
        </td>
      </tr>
    </table>
    <p>What we really want : <b>Don't apply collision when 2 circles are separating</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Frame 1</th>
      <th>Frame 2</th>
      <th>Frame 3</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_6_7.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_8.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_9.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
          </ul>
          Apply collision, result:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
          <b>They are separating, don't apply collision!</b>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
          </ul>
          <b>They are separating, don't apply collision!</b>
        </td>
      </tr>
    </table>
    <p>What we want here is : <b>Only apply collision when circle 2 (C2) is really moving towards cirlce 1 (C1) instead of leaving it!</b></p><p>Recall that we found <code>rel_vx</code> before, which is the relative <code>vx</code> of circle 2 (C2) when circle 1 (C1) is not moving:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Frame 1</th>
      <th>Frame 2</th>
      <th>Frame 3</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_6_7.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_8.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_6_9.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = 0</li>
            <li>c2.vx = -80</li>
            <li><b>rel_vx</b> = c2.vx - c1.vx = 0 - 80 = <b>-80</b></li>
          </ul>
          Apply collision, result:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
          </ul>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
            <li><b>rel_vx</b> = c2.vx - c1.vx = 37.6 - (-42.4) = <b>80</b></li>
          </ul>
          <b>They are separating, don't apply collision!</b>
        </td>
        <td>
          Before apply collison:
          <ul>
            <li>c1.vx = -42.4</li>
            <li>c2.vx = 37.6</li>
            <li><b>rel_vx</b> = c2.vx - c1.vx = 37.6 - (-42.4) = <b>80</b></li>
          </ul>
          <b>They are separating, don't apply collision!</b>
        </td>
      </tr>
    </table>
    <p>From the cases above, we can see, 2 circles are really colliding when <code>rel_vx</code> is <b>negative (rel_vx < 0 )</b>, ie : <b>circle 2 (C2) is moving to left, which is approaching circle 1 (C1) at left!</b></p>
    <p>Now we add the condition that applies collision only when <code>rel_vx</code> is positive, ie : <code>if(rel_vx < 0){ ... }</code>:</p>
    <div class="codeParentDiv" style="height:86em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:0,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:0,
    vy:0
  };
  
  const c2={
    cx:79,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-80,
    vy:0
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx = c2.cx - c1.cx;
    const dy = c2.cy - c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      if(rel_vx < 0){
        c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
        c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
      }
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>              
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>  
        </div>
    </div></div>
    <p>As the newly added condition filters the cases that is not really colliding, now 2 circles don't stick together after colliding:</p>
    <iframe id="iframe-chapter_5_6_10-1" class="center" src="chapter_5_6_10.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_6_10-1').src+='';">Reload</button>
    <p>So we have improved our code, a great step to complete our physics engine!</p>
    <hr class="hr1"/>
    <h2 id="section_7">5.7 Circle-circle collision response at 2D dimension, but at a horizontal line : Basic scenario of 2D collision</h2>
    <p>So, at the former example, 2 circles are at the horizontal line and <code>vy</code> of both are <b>0</b> :</p>
    <iframe id="iframe-chapter_5_6_10-2" class="center" src="chapter_5_6_10.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_6_10-2').src+='';">Reload</button>
    <p>The <b>initial velocities</b> of the case above are shown as the following: </p>
    <iframe class="center" src="chapter_5_7_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>Now lets consider another case : What if <code>vy</code> of circle 2 (C2) is not 0, eg:<b>20</b>?</p>
    <iframe class="center" src="chapter_5_7_2.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>How should we simulate the collision at this case? The answer is simple : <b>No need to modify the formula!</b> At this case, <code>vy</code> <b>is independent of</b> <code>vx</code>, while we would apply the collision at <code>vx</code>, just keep <code>vy</code> remains unchanged! Let's modify the code to set the <code>vy</code> of circle 1 (C1) to see the collision result!</p>
    <div class="codeParentDiv" style="height:84em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:0,
    cy:0,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:0,
    vy:0
  };
  
  const c2={
    cx:79,
    cy:0,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-80,
    vy:20
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  setInterval(function(){
    //circle position update
    c1.cx += c1.vx * 1 / frameRate;
    c1.cy += c1.vy * 1 / frameRate;
    c2.cx += c2.vx * 1 / frameRate;
    c2.cy += c2.vy * 1 / frameRate;

    const dx = c2.cx - c1.cx;
    const dy = c2.cy - c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r + c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      if(rel_vx < 0){
        c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
        c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
      }
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="blue";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy-6);
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="blue";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy-6);
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>When you run the code, you would see circle 1 (C1) moves to left top of the canvas. While we applies the formula to <code>vx</code> <b>as if purely horizontal collision</b>, <code>vy</code> <b>is unaffected</b>, shown as the following:</p>
    <iframe id="iframe-chapter_5_7_3-1" class="center" src="chapter_5_7_3.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_7_3-1').src+='';">Reload</button>
    <p>Compare the cases of circle 2 (C2) that <code>vy</code> is <b>0</b> and the case that <code>vy</code> is <b>20</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2) vy = 0</th>
      <th>Circle 2 (C2) vy = 20</th>
      <tr>
        <td>
          <iframe id="iframe-chapter_5_6_10-3" class="center" src="chapter_5_6_10.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_7_3-2" class="center" src="chapter_5_7_3.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_6_10-3').src+='';document.getElementById('iframe-chapter_5_7_3-2').src+='';">Reload</button>
    <p>We may see that the 2D collision is actually the purely horizontal collision plus <code>vy</code> independently.</p>
    <p>This case looks a bit simple to be a section to mention, right? But it is important : <b>Any 2D collision can be reduced to this case in order to calculate the new <code>vx</code> and <code>vy</code> after collision!</b></p>
    <hr class="hr1"/>
    <h2 id="section_8">5.8 Circle-circle collision response at 2D dimension : circles at any position, vx and vy</h2>
    <p>We implemented circle-circle collisions at 1D and restricted 2D cases, now it is time to implement unrestricted 2D collision!</p>
    <p>So this time we start with 2 circles moving with both <code>vx</code> and <code>vy</code> not equal to <b>0</b> initally:</p>
      <p>Circle 1 (C1):</p>
    <ul>
      <li>cx : -45</li>
      <li>cy : -75</li>
      <li>r : 50</li>
      <li>m : π50<sup>2</sup></li>
      <li>vx : 15</li>
      <li>vy : 30</li>
    </ul>
    <p>Circle 2 (C2):</p>
    <ul>
      <li>cx : 135</li>
      <li>cy : -90</li>
      <li>r : 30</li>
      <li>m : π30<sup>2</sup></li>
      <li>vx : -45</li>
      <li>vy : 60</li>
    </ul>
    <p>As the code at former example is for 1D collision only, so we would comment out the collisoin response code first. We would prepare our code at this example by:</p>
    <ol>
      <li>Update the circle properties</li>
      <li>Add a variable to store the id of setInterval so that we can stop updating the canvas later</li>
      <li>Comment out the previous collision response code, change to stop setInterval when collide</li>
    </ol>
    <p>Now modify the code as the following:</p>
    <div class="codeParentDiv" style="height:88em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-45,
    cy:-75,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:15,
    vy:30
  };

  const c2={
    cx:135,
    cy:-90,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-45,
    vy:60
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;
  const intervalId=setInterval(function(){
    //circle position update
    c1.cx+=c1.vx*1/frameRate;
    c1.cy+=c1.vy*1/frameRate;
    c2.cx+=c2.vx*1/frameRate;
    c2.cy+=c2.vy*1/frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){ //find if d is smaller than (or equals to) r1+r2
      //const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      //if(rel_vx < 0){ //apply collision only when 2 circles are colliding instead of separating
        //c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
        //c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
      //}
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle="blue";
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle="black";
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code> 
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>The canvas should show 2 circles stop when colliding:</p>
    <iframe id="iframe-chapter_5_8_1-1" class="center" src="chapter_5_8_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_8_1-1').src+='';">Reload</button>
    <p>We added <code>intervalId</code> so that we can stop updating the canvas when colliding and the velocities after collision can be kept:</p>
<div class="codeParentDiv" style="height:18em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">    .
    .
    .
    const intervalId=setInterval(function(){
    .
    .
    .
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){
      .
      .
      .
      clearInterval(intervalId)
      .
      .
      .</span></code></pre>
    </div></div>
    <p>Now 2 circles stop immediately when colliding, which behaves as if colliding code not yet implemented. No need to worry! It is necessary because we would implement new code for 2D collision!</p>
    <p>This time, 2D collision is more complicated, so we need more markup on the canvas to help us investigating the collision, we would furthur modifying the code above. Before adding 2D collision code, <b>add additional markup at the canvas</b>:</p>
    <ul>
      <li>Add position (<code>cx</code> and <code>cy</code>)</li>
      <li>Add lines to show <code>vx</code> and <code>vy</code></li>
    </ul>
    <div class="codeParentDiv" style="height:104em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-45,
    cy:-75,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:15,
    vy:30
  };

  const c2={
    cx:135,
    cy:-90,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-45,
    vy:60
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;

  const intervalId=setInterval(function(){
    //circle position update
    c1.cx+=c1.vx*1/frameRate;
    c1.cy+=c1.vy*1/frameRate;
    c2.cx+=c2.vx*1/frameRate;
    c2.cy+=c2.vy*1/frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){ //find if d is smaller than (or equals to) r1+r2
      //const rel_vx = c2.vx - c1.vx; //relative vx of c1 when c2 is not moving
      //if(rel_vx < 0){ //apply collision only when 2 circles are colliding instead of separating
        //c2.vx = (c2.m - c1.m) * rel_vx / (c1.m + c2.m) + c1.vx; //update c2.vx first because c1.vx would be modified, which we need c1.vx before collision 
        //c1.vx = 2 * c2.m * rel_vx / (c1.m + c2.m) + c1.vx;
      //}
      clearInterval(intervalId);
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c1.cx.toFixed(1)+","+c1.cy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.lineTo(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c2.cx.toFixed(1)+","+c2.cy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.lineTo(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>        
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>    
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>    
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>    
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>    
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>When running the code above, 2 circes should stop immediately, like the former one, but with more detailed markup : show the properties when colliding, shown as the below:</p>
    <iframe id="iframe-chapter_5_8_2-1" class="center" src="chapter_5_8_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_8_2-1').src+='';">Reload</button>
    <p>The following table shows the markup of the canvas before and after for comparison:<p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Original</th>
      <th>More detailed markup</th>
      <tr>
        <td>
          <iframe id="iframe-chapter_5_8_1-2" class="center" src="chapter_5_8_1.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_8_2-2" class="center" src="chapter_5_8_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_8_1-2').src+='';document.getElementById('iframe-chapter_5_8_2-2').src+='';">Reload</button>
    <p>Now the canvas shows the name, position and velocity of 2 circles, especially velocity, which represents <code>vx</code> and <code>vy</code> with a line : a more concrete presentation of velocity. </p>
    <p>We may start investigating the 2D collision with the result above!</p>
    <p>First, currently circle 1 (C1) is moving with velocity <b>(15,30)</b>, imagine we move the whole canvas at opposite velocity <b>(-15,-30)</b> so that circle 1 (C1) appears as if not moving, shown as canvases below:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Original canvas</th>
      <th>Moving canvas with velocity (-15,-30)</th>
      <th>Apparent velocity of 2 circles at moving canvas</th>
      <tr>
        <td>
          <iframe id="iframe-chapter_5_8_2-3" class="center" src="chapter_5_8_2.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_8_3-1" class="center" src="chapter_5_8_3.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe id="iframe-chapter_5_8_4-1" class="center" src="chapter_5_8_4.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_8_2-3').src+='';document.getElementById('iframe-chapter_5_8_3-1').src+='';document.getElementById('iframe-chapter_5_8_4-1').src+='';">Reload</button>
    <p>Then circle 2 (C2) appears as if moving with velocity <b>(-45 - 15  , 60 - 30)</b> = <b>(-60 , 30)</b>, which <b>reduced to the case that circle 1 (C1) is not moving</b>.</p>
    <p>Now we may start coding! From the canvas above, we may know that circle 2 (C2) would appear as if moving with new velocities, we call them: <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> ('o' means before colliding, 'rel' means relative velocity):</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Original canvas</th>
      <th>Reduced case</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_5.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_6.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p><code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> can be explained as : <b>apparent velocity of circle 2 (C2) when the camera is chasing circle 1 (C1) so that circle 1 (C1) becomes not moving</b>. The code to find <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code>:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hljs hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;</span></code></pre>
    </div></div>
    <p>Now we would furthur shift the position of 2 circle so that circle 1 (C1) becomes lie on <b>(0,0)</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before shifting circle 1 (C1) to origin</th>
      <th>After shifting circle 1 (C1) to origin</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_7.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_8.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Why would we need to shift the circles? Because we want to <b>furthur reduce the case to 1.5D collision at 5.6, so that we may calculate the collision response easier</b>!</p>
    <p>Currently circle 2 (C2) is not on the x-axis, which has θ from the x axis. To reduce to the case of 1.5D collision (both circles lies on x-axis), we would <b>rotate the canvas clockwise with θ</b>, then <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> would also be rotated θ clockwise, the following canvas shows why would <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> also be rotated and having new values, calling them : <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> (<b>'ro'</b> means <b>rotated</b>), shown as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before rotating θ clocwise</th>
      <th>Rotating θ clocwise</th>
      <th>After rotating θ clocwise</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_9.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_23.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_10.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Why would we reduce the original collision to this 1.5D collision case? Because we need to <b>calculate the final collision response by calculating the collision response in 1.5D collision first</b>!</p> 
    <p>Then how to find <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code>? It becomes a purely mathematical problem: <b>rotate (-60,30) by θ clockwise to find the new coordinate</b>, shown as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Case view</th>
      <th>Mathematical view</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_10.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_24.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Here we would use the possibly the most difficult formula thoughtout the tutorial : <b>x-y clockwise rotation formula</b>:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr><td>x<sub>new</sub> =&nbsp; x cosθ + y sinθ</td></tr>
      <tr><td>y<sub>new</sub> = -x sinθ + y cosθ</td></tr>
    </table>
    <p>Replace the original variables with our using variables:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr><td><b>ro_rel_c2vx_o =&nbsp; rel_c2vx_o * cosθ + rel_c2vy_o * sinθ</b></td></tr>
      <tr><td><b>ro_rel_c2vy_o = -rel_c2vx_o * sinθ + rel_c2vy_o * cosθ</b></td></tr>
    </table>
    <p>The formulae help us to find the new coordinate of a point after the canvas is rotated θ clockwise. Consider the canvas with θ:</p>
    <iframe class="center" src="chapter_5_8_11.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>First, we need to find θ:</p>
    <ul>
      <li>tan θ = 41/68</li>
      <li>θ = 0.5425793241259905 rad (31.087505323479984°)</li>
    </ul>
    <p>So, in order to find <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code>, we would rotate the canvas clockwise by <b>0.5425793241259905 rad</b> (31.087505323479984°) (Note that Javascript trigonometric functions need <b>rad (0 - 2π)</b> instead of <b>degree (0°-360°)</b> as parameters!), then we put <b>0.5425793241259905 rad</b> into the clockwise formula (<b>To be clearer, the numbers shown afterwards would round to 1 decimal when display at canvas</b>):</p>
    <ul>
      <li>ro_rel_c2vx_o =&nbsp;&nbsp;&nbsp;-60 cos(0.5425793241259905) + 30 sin(0.5425793241259905) = <b>-35.89238475092793 (-35.9)</b></li>
      <li>ro_rel_c2vy_o = - -60 sin(0.5425793241259905) + 30 cos(0.5425793241259905) = <b>56.67218644883358 (56.7)</b></li>
    </ul>
    <p>So the old and new velocities are shown as the following:</p>
    <iframe class="center" src="chapter_5_8_12.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>To see the case clearer, the following table shows the actual cases before and after rotation:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Case before rotation</th>
      <th>Case after rotation</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_9.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_13.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>The current mission to do is : <b>calculate the collision response when circle 2 (C2) is collided with static circle 1 (C1) with velocity (-35.9 , 56.7)</b>.</p>
    <p>Great! Let's add <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> into the code... Wait! The way to find <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> above has at least 2 drawbacks:</p>
    <ul>
      <li>tan π/2 (90°) doesn't work</li>
      <li>Calculating θ by finding inverse of tanθ first and then find sinθ and cosθ may cause conversion error in θ</li>
    </ul>
    <p>So, what can we do to avoid the 2 things above? The answer is : <b>eliminate the tanθ above</b>! How can we do that? In fact, both sinθ and cosθ can be expressed in terms of the width and height of the triangle. What does it mean? First, recall the canvas with tanθ before:</p>
    <iframe class="center" src="chapter_5_8_11.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>Here we would use another formula : <b>express tanθ in terms of sinθ and cosθ</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">tanθ = </td>
              <td style="border-bottom:1px solid;"><b>sin θ</b></td>
            </tr>
            <tr>
             <td><b>cos θ</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Here comes a question : what is sinθ and cosθ here? Now don't consider the circles, just focus on the triangle at the middle of the canvas with basic geometry of triangle:</p>
    <iframe class="center" src="chapter_5_8_15.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>From the canvas above, we may see the formulae of sinθ and cosθ are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>sinθ = </b></td>
              <td style="border-bottom:1px solid;">41</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>cosθ = </b></td>
              <td style="border-bottom:1px solid;">68</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Here you may see that sinθ and cosθ are not something newer than tanθ, but can be expressed in terms of the width and height of the triangle!</p>
    <p>After knowing sinθ and cosθ, recall the clockwise rotation formulae:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr><td><b>ro_rel_c2vx_o =&nbsp; rel_c2vx_o * cosθ + rel_c2vy_o * sinθ</b></td></tr>
      <tr><td><b>ro_rel_c2vy_o = -rel_c2vx_o * sinθ + rel_c2vy_o * cosθ</b></td></tr>
    </table>
    <p>This time, we apply the clockwise formula again, but <b>put sinθ and cosθ into the formula directly instead of finding θ first</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vx_o =</b>&nbsp; -60 *</td>
              <td style="border-bottom:1px solid;">68</td>
              <td rowspan="2"> + 30 * </td>
              <td style="border-bottom:1px solid;">41</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">-60 * 68 + 30 * 41</td>
              <td rowspan="2"><b> = -35.89238475092793</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vy_o =</b> - -60 * </td>
              <td style="border-bottom:1px solid;">41</td>
              <td rowspan="2"> + 30 * </td>
              <td style="border-bottom:1px solid;">68</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">- -60 * 41 + 30 * 68</td>
              <td rowspan="2"><b> = 56.67218644883358</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Which the result is identical to the case that finding θ first before:</p>
    <ul>
      <li>ro_rel_c2vx_o =&nbsp;&nbsp;&nbsp;-60 cos(0.5425793241259905) + 30 sin(0.5425793241259905) = <b>-35.89238475092793 (-35.9)</b></li>
      <li>ro_rel_c2vy_o = - -60 sin(0.5425793241259905) + 30 cos(0.5425793241259905) = <b>56.67218644883358 (56.7)</b></li>
    </ul>
    <p>So, we know how to calculate <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> directly <b>without calculating θ</b>. That looks charming, right? It is time to continue our coding! Now we replace the real numbers with variables in the canvas:</p>
    <iframe class="center" src="chapter_5_8_14.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>To replace the numbers easier, the following table puts 2 versions together for comparison:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Case with real numbers</th>
      <th>Case with variables</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_15.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_14.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>As you may see, the width and height of the triangle are <code>dx</code> and <code>dy</code>, which we found at checking collision already! so we may find sinθ and cosθ in terms of <code>dx</code> and <code>dy</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>sinθ = </b></td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>cosθ = </b></td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Recall the clockwise rotation formulae again:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr><td><b>ro_rel_c2vx_o =&nbsp; rel_c2vx_o * cosθ + rel_c2vy_o * sinθ</b></td></tr>
      <tr><td><b>ro_rel_c2vy_o = -rel_c2vx_o * sinθ + rel_c2vy_o * cosθ</b></td></tr>
    </table>
    <p>And the new formula to find <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vx_o =</b>&nbsp;&nbsp;  rel_c2vx_o * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> + rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;"><b>rel_c2vx_o * dx + rel_c2vy_o * dy</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vy_o =</b>&nbsp;- rel_c2vx_o *</td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + rel_c2vy_o *</td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;"><b>-rel_c2vx_o * dy + rel_c2vy_o * dx</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Now add <code>ro_rel_c2vx_o</code> and <code>ro_rel_c2vy_o</code> to the code:</p>
    <div class="codeParentDiv" style="height:7em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;
const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);
</span></code></pre>
    </div></div>
    <p>Recall that we are trying to calculate the collision response of the following 1.5D collision case:</p>
    <iframe class="center" src="chapter_5_8_10.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <p>Remember, we need to <b>avoid 2 circles stick together when colliding (see section 5.5)</b>, so we need to add a condition <code>ro_rel_c2vx_o < 0</code>: only applies collision when circle 2 (C2) is really moving towards circle 1 (C1) (moving to left) instead of separating from circle 1 (C1):</p>
    <div class="codeParentDiv" style="height:9em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;
const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);
}
</span></code></pre>
    </div></div>
    <p>Note that we move <code>ro_rel_c2vy_o</code> into the condition because <code>ro_rel_c2vy_o</code> is useful only when collision really occurs.</p>
    <p>Now we are going to calculate the collision response. <b>After collision, both circles keep the original <code>vy</code>, but would have new <code>vx</code></b> which we don't know the value currently because of not yet calculated. Here we need to introduce new variables for the new <code>vy</code> of 2 circles after collision : <code>ro_rel_c1vx_n</code> and <code>ro_rel_c2vx_n</code> (<b>'n_' means new, after collision, opposite to 'o_' before collision</b>). After cirlce (C2) colliding with circle (C1), <code>ro_rel_c2vx_o</code> would change to <code>ro_rel_c2vx_n</code>, also <code>vx</code> <b>of circle 1 (C1) is not 0 anymore</b>, becomes <code>ro_rel_c1vx_n</code>. The following canvas shows the new variables:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Velocities before collision at 1.5D collision</th>
      <th>Velocities after collision at 1.5D collision</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_16.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_32.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Now we are going to find <code>ro_rel_c1vx_n</code> and <code>ro_rel_c2vx_n</code>. Recall the collision formulae of 1.5D collision at section 5.6:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>aNew</sub> (reduced case)</b> = </td>
        <td style="border-bottom:1px solid;">2*M<sub>b</sub>*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>V<sub>bNew</sub> (reduced case)</b> = </td>
        <td style="border-bottom:1px solid;">(M<sub>b</sub>-M<sub>a</sub>)*V<sub>bOld</sub></td>
      </tr>
      <tr>
        <td>M<sub>a</sub>+M<sub>b</sub></td>
      </tr>
    </table>
    <p>Replace the original variables in formulae with our using variables:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c1vx_n = </td>
        <td style="border-bottom:1px solid;">2 * c2.m * ro_rel_c2vx_o</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c2vx_n = </td>
        <td style="border-bottom:1px solid;">(c2.m - c1.m) * ro_rel_c2vx_o</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <p>In this case, V<sub>bOld</sub> is <b>-35.89238475092793</b>, then <code>ro_rel_c1vx_n</code> and <code>ro_rel_c2vx_n</code> are:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2">ro_rel_c1vx_n = </td>
        <td style="border-bottom:1px solid;">2*π30<sup>2</sup>*-35.89238475092793</td>
        <td rowspan="2"> = -19.001850750491258</td>
      </tr>
      <tr>
        <td>π30<sup>2</sup>+π50<sup>2</sup></td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2">ro_rel_c2vx_n = </td>
        <td style="border-bottom:1px solid;">(π30<sup>2</sup>-π50<sup>2</sup>)*-35.89238475092793</td>
        <td rowspan="2"> = 16.890534000436674</td>
      </tr>
      <tr>
        <td>π30<sup>2</sup>+π50<sup>2</sup></td>
      </tr>
    </table>
    <p>After collision, the new velocities of both circles are shown as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Velocities before collision</th>
      <th>Velocities after collision</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_16.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_17.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>After calculating with real values, to continue implementing the collision code, let's go back to the example with variables. Recall the formulae of collision response of 1.5D collision:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c1vx_n = </td>
        <td style="border-bottom:1px solid;">2 * c2.m * ro_rel_c2vx_o</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c2vx_n = </td>
        <td style="border-bottom:1px solid;">(c2.m - c1.m) * ro_rel_c2vx_o</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <p>Replace the real values with variables:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Velocities before collision</th>
      <th>Velocities after collision</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_19.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_20.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>We continue to implement the collision response by writing the formulae above into the code:</p>
    <div class="codeParentDiv" style="height:12em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;
const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

  const ro_rel_c1vx_n = ro_rel_c2vx_o * 2 * c2.m / (c1.m + c2.m);
  const ro_rel_c2vx_n = ro_rel_c2vx_o * (c2.m - c1.m) / (c1.m + c2.m);
}
</span></code></pre>
    </div></div>
    <p>We have already calculated the new velocities of 2 circles after colliding in 1.5D collision. But the current velocities are not our original case. So we need to <b>revert the 1.5D collision to the original 2D collision</b>!</p>
    <p>The last step we did is rotating the canvas θ <b>clockwise</b>, so the first thing to do for reverting the case is rotating the canvas θ <b>counter-clockwise</b>. After rotating the canvas, it becomes <b>no rotation compare with the original case</b>, and both circles would have new velocities again: <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code> <b>(remove 'cl_' to indicate no rotation)</b>, shown as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before rotating θ counter-clockwise</th>
      <th>Rotating θ counter-clockwise</th>
      <th>After rotating θ counter-clockwise</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_21.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_25.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_22.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Now we need to find <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>. Again, it is a pure mathematical problem that we need to find the new coordinates of points after rotation, but this time <b>rotating θ counter-clockwise</b>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Old and new velocities of circle 1 (C1)</th>
      <th>Old and new velocities of circle 2 (C2)</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_28.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_30.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>In order to find <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>, we would use another formulae : <b>x-y counter-clockwise formulae</b>, which is different from the <b>clockwise formulae</b> before:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr><td>x<sub>new</sub> = x cosθ - y sinθ</td></tr>
      <tr><td>y<sub>new</sub> = x sinθ + y cosθ</td></tr>
    </table>
    <p>To see the difference more clearly, the following table places 2 groups of formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr><td>Clockwise rotation formulae</td><td><b>Counter-Clockwise rotation formulae</b></td></tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;">
            <tr><td>x<sub>new</sub> =&nbsp;&nbsp; x cosθ + y sinθ</td></tr>
            <tr><td>y<sub>new</sub> = - x sinθ + y cosθ</td></tr>
          </table>
        </td>
        <td>
          <table style="margin-left:auto;margin-right:auto;">
            <tr><td>x<sub>new</sub> = x cosθ - y sinθ</td></tr>
            <tr><td>y<sub>new</sub> = x sinθ + y cosθ</td></tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Replace the original variables with our using variables above:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td colspan="2" style="text-align:center;">Cirlce 1 (C1) :</td>
      </tr>
      <tr><td><b>rel_c1vx_n</b> = ro_rel_c1vx_n * cosθ - 0.0 * sinθ = ro_rel_c1vx_n * cosθ</td></tr>
      <tr><td><b>rel_c1vy_n</b> = ro_rel_c1vx_n * sinθ + 0.0 * cosθ = ro_rel_c1vx_n * sinθ</td></tr>
    </table>
    <br/>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td colspan="2" style="text-align:center;">Cirlce 2 (C2) :</td>
      </tr>
      <tr><td><b>rel_c2vx_n</b> = ro_rel_c2vx_n * cosθ - ro_rel_c2vy_o * sinθ</td></tr>
      <tr><td><b>rel_c2vy_n</b> = ro_rel_c2vx_n * sinθ + ro_rel_c2vy_o * cosθ</td></tr>
    </table>
    <p>Again, instead of finding θ first, we would replace sinθ and cosθ directly, recall the sinθ and cosθ formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>sinθ = </b></td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>cosθ = </b></td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Also recall the values of sinθ and cosθ in our case:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>sinθ = </b></td>
              <td style="border-bottom:1px solid;">41</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>cosθ = </b></td>
              <td style="border-bottom:1px solid;">68</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>So, replace the variables of formulae with numbers, we may find the new velocities after rotating θ counter-clockwise as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vx_n =</b>&nbsp; -19.001850750491258 *</td>
              <td style="border-bottom:1px solid;">68</td>
              <td rowspan="2"><b> = -16.27279936558287</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vy_n =</b> -19.001850750491258 * </td>
              <td style="border-bottom:1px solid;">41</td>
              <td rowspan="2"><b> = -9.811540793954377</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <br/><table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vx_n =</b> 16.890534000436674 *</td>
              <td style="border-bottom:1px solid;">68</td>
              <td rowspan="2"> - 56.67218644883358 * </td>
              <td style="border-bottom:1px solid;">41</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">16.890534000436674 * 68 - 56.67218644883358 * 41</td>
              <td rowspan="2"> = <b>-14.797779540047582</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vy_n =</b> 16.890534000436674 * </td>
              <td style="border-bottom:1px solid;">41</td>
              <td rowspan="2"> + 56.67218644883358 * </td>
              <td style="border-bottom:1px solid;">68</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">16.890534000436674 * 41 + 56.67218644883358 * 68</td>
              <td rowspan="2"> = <b>57.2542799832066</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
             <td>√<span style="border-top:1px solid;">68 * 68 + 41 * 41</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>So the velocities before and after rotating θ counter-clockwise are shown as the following canvas:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before rotating θ counter-clockwise</th>
      <th>After rotating θ counter-clockwise</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_29.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_31.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>The actual velocities of both circles after rotating θ counter-clockwise are shown as the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before rotating θ counter-clockwise</th>
      <th>After rotating θ counter-clockwise</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_21.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_34.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>After seeing the actual case with real numbers, to continue our coding, let's replace the real numbers with variables:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before rotating θ counter-clockwise</th>
      <th>After rotating θ counter-clockwise</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_33.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_22.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Recall the formulae of <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td colspan="2" style="text-align:center;">Cirlce 1 (C1) :</td>
      </tr>
      <tr><td><b>rel_c1vx_n</b> = ro_rel_c1vx_n * cosθ - 0.0 * sinθ = ro_rel_c1vx_n * cosθ</td></tr>
      <tr><td><b>rel_c1vy_n</b> = ro_rel_c1vx_n * sinθ + 0.0 * cosθ = ro_rel_c1vx_n * sinθ</td></tr>
    </table>
    <br/>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td colspan="2" style="text-align:center;">Cirlce 2 (C2) :</td>
      </tr>
      <tr><td><b>rel_c2vx_n</b> = ro_rel_c2vx_n * cosθ - ro_rel_c2vy_o * sinθ</td></tr>
      <tr><td><b>rel_c2vy_n</b> = ro_rel_c2vx_n * sinθ + o_cl_rel_v2vy * cosθ</td></tr>
    </table>
    <p>Also, we would replace cosθ and sinθ directly without finding θ first:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>sinθ = </b></td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>cosθ = </b></td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>So, the formulae are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vx_n = ro_rel_c1vx_n *</b></td>
              <td style="border-bottom:1px solid;"><b>dx</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vy_n = ro_rel_c1vx_n * </b></td>
              <td style="border-bottom:1px solid;"><b>dy</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <br/><table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vx_n =</b>&nbsp; ro_rel_c2vx_n *</td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - ro_rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;"><b>ro_rel_c2vx_n * dx - ro_rel_c2vy_o * dy</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vy_n =</b> ro_rel_c2vx_n * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + ro_rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;"><b>ro_rel_c2vx_n * dy + ro_rel_c2vy_o * dx</b></td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Convert the formulae to codes in order to find <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>:</p>
    <div class="codeParentDiv" style="height:17em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;
const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

  const ro_rel_c1vx_n = ro_rel_c2vx_o * 2 * c2.m / (c1.m + c2.m);
  const ro_rel_c2vx_n = ro_rel_c2vx_o * (c2.m - c1.m) / (c1.m + c2.m);

  const rel_c1vx_n = ro_rel_c1vx_n * dx / Math.sqrt(dx * dx + dy * dy);
  const rel_c1vy_n = ro_rel_c1vx_n * dy / Math.sqrt(dx * dx + dy * dy);
  const rel_c2vx_n = (ro_rel_c2vx_n * dx - ro_rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
  const rel_c2vy_n = (ro_rel_c2vx_n * dy + ro_rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);
}</span></code></pre>
    </div></div>
    <p>We are almost finished our collision handling code! However, <code>rel_c1vx_n</code>, <code>rel_c1vy_n</code>, <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code> are not the final velocities at the original case, remember we reduce the original case into the case that circle 1 (C1) is not moving, right? To restore the velocities to the original case, we would do the opposite : <b>add back the velocity of circle 1 (C1) to both circles</b>! So the final formulae of the new velocities of both circles are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          c1.vx = <b>c1.vx + </b>-16.27279936558287</b>
        </td>
      </tr>
      <tr>
        <td>
          c1.vy = <b>c1.vy + </b>-9.811540793954377</b>
        </td>
      </tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          c2.vx = <b>c1.vx + </b>-14.797779540047582</b>
        </td>
      </tr>
      <tr>
        <td>
          c2.vy = <b>c1.vy + </b>57.2542799832066</b>
        </td>
      </tr>
    </table>
    <p>So the final velocities are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          c1.vx = 15 - 16.27279936558287 = -1.2727993655828698</b>
        </td>
      </tr>
      <tr>
        <td>
          c1.vy = 30 - 9.8115407939543778 = 20.18845920604562</b>
        </td>
      </tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          c2.vx = 15 - 14.797779540047582 = 0.202220459952418</b>
        </td>
      </tr>
      <tr>
        <td>
          c2.vy = 30 + 57.2542799832066 = 87.2542799832066</b>
        </td>
      </tr>
    </table>
    <p>The following table shows the cases that before and after adding back velocity of circle 1 (C1) so that we can see what we did clearer:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Before adding back original velocity of circle 1 (C1)</th>
      <th>After adding back original velocity of circle 1 (C1)</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_35.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_36.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>So the final velocities are:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          c1.vx = <b>c1.vx + </b>rel_c1vx_n</b>
        </td>
      </tr>
      <tr>
        <td>
          c1.vy = <b>c1.vy + </b>rel_c1vy_n</b>
        </td>
      </tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          c2.vx = <b>c1.vx + </b>rel_c2vx_n</b>
        </td>
      </tr>
      <tr>
        <td>
          c2.vy = <b>c1.vy + </b>rel_c2vy_n</b>
        </td>
      </tr>
    </table>
    <p>Add the formulae into the code <b>(Note: this time we update c2 first because c1.vx += ... and c1.vy += ... would change the original value)</b>:</p>
    <div class="codeParentDiv" style="height:22em"><div class="hljs readborder" style="position:absolute;">
      <pre><code><span class="hl">const rel_c2vx_o = c2.vx - c1.vx;
const rel_c2vy_o = c2.vy - c1.vy;
const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

  const ro_rel_c1vx_n = ro_rel_c2vx_o * 2 * c2.m / (c1.m + c2.m);
  const ro_rel_c2vx_n = ro_rel_c2vx_o * (c2.m - c1.m) / (c1.m + c2.m);

  const rel_c1vx_n = ro_rel_c1vx_n * dx / Math.sqrt(dx * dx + dy * dy);
  const rel_c1vy_n = ro_rel_c1vx_n * dy / Math.sqrt(dx * dx + dy * dy);
  const rel_c2vx_n = (ro_rel_c2vx_n * dx - ro_rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
  const rel_c2vy_n = (ro_rel_c2vx_n * dy + ro_rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

  c2.vx = c1.vx + rel_c2vx_n;
  c2.vy = c1.vy + rel_c2vy_n;
  c1.vx += rel_c1vx_n;
  c1.vy += rel_c1vy_n;
}</span></code></pre>
  </div></div>
    <p>Finally, we can test our collision code now! Add the 2D collision code into the code of the example at the beginning as the following (also remove <code>const intervalId=</code> before <code>setInterval(function(){</code> as now we don't need to stop the circles when colliding):</p>
    <div class="codeParentDiv" style="height:117em"><div class="hljs copyborder" style="position:absolute;">
      <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">
  const c1={
    cx:-45,
    cy:-75,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:15,
    vy:30
  };

  const c2={
    cx:135,
    cy:-90,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-45,
    vy:60
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;

  setInterval(function(){
    //circle position update
    c1.cx+=c1.vx*1/frameRate;
    c1.cy+=c1.vy*1/frameRate;
    c2.cx+=c2.vx*1/frameRate;
    c2.cy+=c2.vy*1/frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){ //find if d is smaller than (or equals to) r1+r2
      const rel_c2vx_o = c2.vx - c1.vx;
      const rel_c2vy_o = c2.vy - c1.vy;
      const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
      if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating
        const ro_rel_c2vy_o = (-rel_c2vx_o * dy + rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

        const ro_rel_c1vx_n = ro_rel_c2vx_o * 2 * c2.m / (c1.m + c2.m);
        const ro_rel_c2vx_n = ro_rel_c2vx_o * (c2.m - c1.m) / (c1.m + c2.m);

        const rel_c1vx_n = ro_rel_c1vx_n * dx / Math.sqrt(dx * dx + dy * dy);
        const rel_c1vy_n = ro_rel_c1vx_n * dy / Math.sqrt(dx * dx + dy * dy);
        const rel_c2vx_n = (ro_rel_c2vx_n * dx - ro_rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
        const rel_c2vy_n = (ro_rel_c2vx_n * dy + ro_rel_c2vy_o * dx) / Math.sqrt(dx * dx + dy * dy);

        c2.vx = c1.vx + rel_c2vx_n;
        c2.vy = c1.vy + rel_c2vy_n;
        c1.vx += rel_c1vx_n;
        c1.vy += rel_c1vy_n;
      }
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c1.cx.toFixed(1)+","+c1.cy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.lineTo(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c2.cx.toFixed(1)+","+c2.cy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.lineTo(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
    </div></div>
    <p>The collision result is shown as the following:</p>
    <iframe id="iframe-chapter_5_8_37-1" class="center" src="chapter_5_8_37.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_8_37-1').src+='';">Reload</button>
    <p>As this section is long and complex, let we summerize how we handle 2D collision of circles at the following (the bottom of tables show the newly added variables):</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th colspan="2">1. Find velocity of circle 2 (C2) relative to circle 1 (C1) to reduce to the case that circle 2 (C2) is not moving</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_5.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_6.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr><td colspan="2" style="text-align:center;"><code>rel_c2vx_o</code> , <code>rel_c2vy_o</code></td></tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th colspan="3">2. Rotate the canvas to reduce to the case that both circles lie on x-axis as 1.5D collision</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_6.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_10.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr><td colspan="2" style="text-align:center;"><code>ro_rel_c2vx_o</code> , <code>ro_rel_c2vy_o</code></td></tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th colspan="3">3. Apply collision to find new velocities of both circles at the reduced case</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_19.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_20.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr><td colspan="2" style="text-align:center;"><code>ro_rel_c1vx_n</code> , <code>ro_rel_c2vx_n</code></td></tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th colspan="3">4. Rotate canvas so that it reverts to the original angle, then find new velocities after rotation</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_20.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_22.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
      <tr><td colspan="2" style="text-align:center;"><code>rel_c1vx_n</code> , <code>rel_c1vy_n</code> , <code>rel_c2vx_n</code> , <code>rel_c2vy_n</code></td></tr>
    </table>
    <br/>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th colspan="3">5. Add back the original velocity of circle 1 (C1) to both circles at (4)</th>
      <tr>
        <td>
          <iframe class="center" src="chapter_5_8_22.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
        <td>
          <iframe class="center" src="chapter_5_8_38.html" width="400px" height="400" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
        </td>
      </tr>
    </table>
    <p>Congratulations! you finished the probably the most difficult part of circle-circle collision : 2D collision handling! Our physics engine are almost finished!</p>
    <hr class="hr1"/>
    <h2 id="section_9">5.9 Verify the result : calculate the total energy before and after collison</h2>
    <p>Great! After a long tutorial, the collison response seems look normal, right? But... How can we verify the formulae above is correct?</p>
    <p>We can <b>check if the total kinetic energy of circle 1 (C1) and circle 2 (C2) before and after collison are equal</b>! So the kinetic energy of a circle is:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * mass of circle * velocity of circle<sup>2</sup> </td>
            </tr>
            <tr>
            <td><b>2</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>But in our case, there are <code>vx</code> and <code>vy</code> in the circle, how to calculate the velocity required by the formula?</p>
    <p>The answer is simple : apply Pythagorean theorem to the velocity:</p>
    <p style="text-align:center">velocity of circle<sup>2</sup>= <code>vx</code> of circle<sup>2</sup> + <code>vy</code> of circle<sup>2</sup></p>
    <p>Note that we need velocity of circle<sup>2</sup> instead of just velocity of circle. So the formula becomes:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * mass of circle * (<code>vx</code> of circle<sup>2</sup> + <code>vy</code> of circle<sup>2</sup>) </td>
            </tr>
            <tr>
            <td><b>2</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The <b>total energy of 2 circles</b> is:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * c1.m * (c1.vx<sup>2</sup> + c1.vy<sup>2</sup>) + </td>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * c2.m * (c2.vx<sup>2</sup> + c2.vy<sup>2</sup>)</td>
            </tr>
            <tr>
              <td><b>2</b></td>
              <td><b>2</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>We may get the velocities of the circles after colliding by adding <code>alert(c1.vx+","+c1.vy+"|"+c2.vx+","+c2.vy);</code> into the code to see the outpupt.</p>
    <p>At section 5.6, Circle 1 (C1) and Circle 2(C2), their total energy <b>before collison</b> is:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * π50<sup>2</sup> * (15<sup>2</sup> + 30<sup>2</sup>) + </td>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * π30<sup>2</sup> * ((-45)<sup>2</sup> + (60)<sup>2</sup>) = 12370021.07350981</td>
            </tr>
            <tr>
              <td><b>2</b></td>
              <td><b>2</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p><b>After collison</b> (for simplicity, just use the velocities that rounded to 1 decimal shown at the canvas above):</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * π50<sup>2</sup> * (-1.2727993655828733<sup>2</sup> + 20.18845920604562<sup>2</sup>) + </td>
              <td style="border-bottom:1px solid;"><b>1</b></td>
              <td rowspan="2"> * π30<sup>2</sup> * (0.202220459952418<sup>2</sup> + 87.2542799832066<sup>2</sup>) = 12370021.073509809</td>
            </tr>
            <tr>
              <td><b>2</b></td>
              <td><b>2</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>So the total energy before collison is 12370021.07350981, after collision is 12370021.073509809, it is almost the same, so it can support the collision formulae have high possibiliby to be correct!</p>
    <hr class="hr1"/>
    <h2 id="section_10">5.10 Refactor the code : eliminate the square root</h2>
    <p>So we finished the 2D collision code before, which is probably the most difficult part in this section. But that is not finished : we can refactor the code so that no square root is required in our code! How to do that? First lets look back to see the collision detection code:</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">if(Math.sqrt(dx*dx + dy*dy) <= c1.r+c2.r){ //find if d is smaller than (or equals to) r1+r2</span></code></pre>
    </div></div>
    <p>We may <b>square both sides</b> so that the <b>checking result remains unchanged</b>:</p>
    <div class="codeParentDiv" style="height:5em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">if(dx * dx + dy * dy <= (c1.r + c2.r)*(c1.r + c2.r)){ //find if d is smaller than (or equals to) r1+r2</span></code></pre>
    </div></div>
    <p>Then recall the code that avoid 2 circles stick together:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
if(ro_rel_c2vx_o < 0){ //apply collision only when 2 circles are colliding instead of separating</span></code></pre>
    </div></div>
    <p>First, we can put the formulae directly into the checking:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">    
        <pre><code><span class="hl">if( (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy) < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);</span></code></pre>
    </div></div>
    <p>Multiply the checking condition by at both sides : <code>a * Math.sqrt(b) / Math.sqrt(b) < 0*Math.sqrt(b)</code>, we may know checking <code>a / Math.sqrt(b) < 0</code> is equal to check <code>a < 0</code> ,so the formula can rewrite as:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">if(rel_c2vx_o * dx + rel_c2vy_o * dy < 0){ //apply collision only when 2 circles are colliding instead of separating
  const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);</span></code></pre>
    </div></div>
    <p>Now the code is changed to the following:</p>
    <div class="codeParentDiv" style="height:14em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">.
.
.
if(dx * dx + dy * dy <= (c1.r + c2.r)*(c1.r + c2.r)){ //find if d is smaller than (or equals to) r1+r2
  const rel_c2vx_o = c2.vx - c1.vx;
  const rel_c2vy_o = c2.vy - c1.vy;
  if(rel_c2vx_o * dx + rel_c2vy_o * dy < 0){ //apply collision only when 2 circles are colliding instead of separating
    const ro_rel_c2vx_o = (rel_c2vx_o * dx + rel_c2vy_o * dy) / Math.sqrt(dx * dx + dy * dy);
    .
    .
    .</span></code></pre>
    </div></div>
    <p>Now we would simplify the collision formulae of 2 circles! We start with circle 1 (C1) because the formulae are simpler. We would simiplfy them by replacing the variables with their formulae. Recall the <b>final formulae</b>, first we start replacing <code>rel_c1vx_n</code> and <code>rel_c1vy_n</code> with their formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          c1.vx = c1.vx + <b>rel_c1vx_n</b>
        </td>
      </tr>
      <tr>
        <td>
          c1.vy = c1.vy + <b>rel_c1vy_n</b>
        </td>
      </tr>
    </table>
    <p>Formulae of <code>rel_c1vx_n</code> and <code>rel_c1vy_n</code>:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vx_n =</b>&nbsp; ro_rel_c1vx_n *</td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c1vy_n =</b> ro_rel_c1vx_n * </td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The final formulae become the following, and the next variables to be replaced are <code>ro_rel_c1vx_n</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vx = c1.vx + <b>ro_rel_c1vx_n</b> *</td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vy = c1.vy + <b>ro_rel_c1vx_n</b> * </td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Recall the formula of <code>ro_rel_c1vx_n</code>:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c1vx_n = </td>
        <td style="border-bottom:1px solid;">2 * c2.m * ro_rel_c2vx_o</td>
        <td rowspan="2"> = ro_rel_c2vx_o * </td>
       <td style="border-bottom:1px solid;">2 * c2.m</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <p>The formulae become the following, and the next variable to be replaced is <code>ro_rel_c2vx_o</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vx = c1.vx + ro_rel_c2vx_o *</td>
              <td style="border-bottom:1px solid;">2 * c2.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> = c1.vy + <b>ro_rel_c2vx_o</b> *</td>
              <td style="border-bottom:1px solid;">2 * c2.m * dx</td>
            </tr>
            <tr>
             <td>c1.m + c2.m</td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>(c1.m + c2.m) * √<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vy = c1.vy + ro_rel_c2vx_o * </td>
              <td style="border-bottom:1px solid;">2 * c2.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> = c1.vy + <b>ro_rel_c2vx_o</b> *</td>
              <td style="border-bottom:1px solid;">2 * c2.m * dy</td>
            </tr>
            <tr>
             <td>c1.m + c2.m</td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>(c1.m + c2.m) * √<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Now we would replace <code>ro_rel_c2vx_o</code>, recall the formula:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vx_o =</b>&nbsp;&nbsp;  rel_c2vx_o * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> + rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Replace <code>ro_rel_c2vx_o</code> with the formula:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vx = c1.vx + </td>
              <td style="border-bottom:1px solid;"> 2 * c2.m * dx </td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
            </tr>
            <tr>
             <td>(c1.m + c2.m) * √<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
	     <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vy = c1.vy + </td>
              <td style="border-bottom:1px solid;"> 2 * c2.m * dy </td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
            </tr>
            <tr>
             <td>(c1.m + c2.m) * √<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
	     <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The formulae becomes the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vx = c1.vx + </td>
              <td style="border-bottom:1px solid;"><b>2 * dx * c2.m * (rel_c2vx_o * dx + rel_c2vy_o * dy)</b></td>
            </tr>
            <tr>
             <td><b>(c1.m + c2.m) * (dx * dx + dy * dy)</b></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c1.vy = c1.vy + </td>
              <td style="border-bottom:1px solid;"><b>2 * dy * c2.m * (rel_c2vx_o * dx + rel_c2vy_o * dy)</b></td>
            </tr>
            <tr>
             <td><b>(c1.m + c2.m) * (dx * dx + dy * dy)</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The code of formulae of circle 1 (C1) becomes:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">    
      <pre><code><span class="hl">c1.vx += 2 * dx * c2.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
c1.vy += 2 * dy * c2.m * (rel_c2vx_o * dx + o_srel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);</span></code></pre>
    </div></div>
    <p>Now we would simplify the formulae of circle 2 (C2) by replacing the variables with their formulae too. But before replacing variables, we would modify the formulae first. Recall the formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          c2.vx = <b>c1.vx + </b>rel_c2vx_n</b>
        </td>
      </tr>
      <tr>
        <td>
          c2.vy = <b>c1.vy + </b>rel_c2vy_n</b>
        </td>
      </tr>
    </table>
    <p>First, we would add <code>-c2.vx + c2.vx</code> and <code>-c2.vy + c2.vy</code> into them so that we can eliminate <code>c1.vx</code> and <code>c1.vy</code>, rewrite them as: </p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          c2.vx = <b>c1.vx - c2.vx + c2.vx</b> + rel_c2vx_n
        </td>
      </tr>
      <tr>
        <td>
          c2.vy = <b>c1.vy - c2.vy + c2.vy</b> + rel_c2vy_n
        </td>
      </tr>
    </table>
    <p>Which the formulae become the following (<code>c1.vx - c2.vx</code> becomes <code>-rel_c2vx_o</code>, <code>c1.vy - c2.vy</code> becomes <code>-rel_c2vy_o</code>), then we would replace <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          c2.vx = c2.vx + rel_c2vx_n + (c1.vx - c2.vx) = c1.vx + <b>rel_c2vx_n</b> - rel_c2vx_o
        </td>
      </tr>
      <tr>
        <td>
          c1.vy = c1.vy + rel_c2vy_n + (c1.vy - c2.vy) = c1.vy + <b>rel_c2vy_n</b> - rel_c2vy_o
        </td>
      </tr>
    </table>
    <p>Recall the formulae of <code>rel_c2vx_n</code> and <code>rel_c2vy_n</code>:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vx_n =</b>&nbsp; ro_rel_c2vx_n *</td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - ro_rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dy</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>rel_c2vy_n =</b> 	ro_rel_c2vx_n * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + ro_rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dx</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Then the formulae become the following, and we would replace <code>ro_rel_c2vx_n</code> and <code>ro_rel_c2vy_o</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + <b>ro_rel_c2vx_n</b> *</td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - <b>ro_rel_c2vy_o</b> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + <b>ro_rel_c2vx_n</b> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + <b>ro_rel_c2vy_o</b> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
             <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Recall the formula of <code>ro_rel_c2vx_n</code>:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c2vx_n = </td>
        <td style="border-bottom:1px solid;">(c2.m - c1.m) * ro_rel_c2vx_o</td>
        <td rowspan="2"> = ro_rel_c2vx_o * </td>
        <td style="border-bottom:1px solid;">c2.m - c1.m</td>
      </tr>
      <tr>
        <td>c1.m + c2.m</td>
        <td>c1.m + c2.m</td>
      </tr>
    </table>
    <p>and <code>ro_rel_c2vy_o</code>:</p>
    <table style="margin-left:auto;margin-right:auto;text-align:center;">
      <tr>
        <td rowspan="2"><b>ro_rel_c2vy_o =</b>&nbsp;- rel_c2vx_o *</td>
        <td style="border-bottom:1px solid;">dy</td>
        <td rowspan="2"> + rel_c2vy_o *</td>
        <td style="border-bottom:1px solid;">dx</td>
        <td rowspan="2"> = </td>
        <td style="border-bottom:1px solid;">-rel_c2vx_o * dy + rel_c2vy_o * dx</td>
      </tr>
      <tr>
        <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
        <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
        <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
      </tr>
    </table>
    <p>The formulae becomes the following, and then replace <code>ro_rel_c2vx_o</code>:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 1 (C1):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + <b>ro_rel_c2vx_o</b> *</td>
              <td style="border-bottom:1px solid;">c2.m - c1.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy + rel_c2vy_o * dx</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>c1.m + c2.m</td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + <b>ro_rel_c2vx_o</b> * </td>
              <td style="border-bottom:1px solid;">c2.m - c1.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy + rel_c2vy_o * dx</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>c1.m + c2.m</td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Now we would replace <code>ro_rel_c2vx_o</code>, recall the formula:</p>
    <table style="margin-left:auto;margin-right:auto;">
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2"><b>ro_rel_c2vx_o =</b>&nbsp;&nbsp;  rel_c2vx_o * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> + rel_c2vy_o * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> = </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
            </tr>
            <tr>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
              <td>√<span style="border-top:1px solid;">dx * dx + dy * dy</span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The formulae become the following:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">c2.m - c1.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy + rel_c2vy_o * dx</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>c1.m + c2.m</td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o * dx + rel_c2vy_o * dy</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">c2.m - c1.m</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dy</td>
              <td rowspan="2"> + </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy + rel_c2vy_o * dx</td>
              <td rowspan="2"> * </td>
              <td style="border-bottom:1px solid;">dx</td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>c1.m + c2.m</td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
              <td>√<span style="border-top:1px solid;"><b>dx * dx + dy * dy</b></span></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The formulae looks a bit long, right? Let we simplify them step by step! From above, we can see the square root sign can be eliminated because there are 2 square root of <code>dx * dx + dy * dy</code> multiplies together, so the formulae can be simplified as: </p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;">(rel_c2vx_o * dx * dx + rel_c2vy_o * dy * dx) * (c2.m - c1.m)</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy * dy + rel_c2vy_o * dx * dy</td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * <b>(c1.m + c2.m)</b></td>
              <td>dx * dx + dy * dy</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;">(rel_c2vx_o * dx * dy + rel_c2vy_o * dy * dy) * (c2.m - c1.m)</td>
              <td rowspan="2"> + </td>
              <td style="border-bottom:1px solid;">-rel_c2vx_o * dy * dx + rel_c2vy_o * dx * dx</td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * <b>(c1.m + c2.m)</b></td>
              <td>dx * dx + dy * dy</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>In order to furthur simplify the formulae, we need to multiply <code>c1.m + c2.m</code> at the second fraction:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;">(rel_c2vx_o * dx * dx + rel_c2vy_o * dy * dx) * (c2.m - c1.m)</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;">(-rel_c2vx_o * dy * dy + rel_c2vy_o * dx * dy) * <b>(c1.m + c2.m)</b></td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
              <td>(dx * dx + dy * dy) * <b>(c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;">(rel_c2vx_o * dx * dy + rel_c2vy_o * dy * dy) * (c2.m - c1.m)</td>
              <td rowspan="2"> + </td>
              <td style="border-bottom:1px solid;">(-rel_c2vx_o * dy * dx + rel_c2vy_o * dx * dx) * <b>(c1.m + c2.m)</b></td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
              <td>(dx * dx + dy * dy) * <b>(c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Then the upper part of the fractions can add together:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;"><b>(rel_c2vx_o * dx * dx + rel_c2vy_o * dy * dx) * (c2.m - c1.m) - (-rel_c2vx_o * dy * dy + rel_c2vy_o * dx * dy) * (c1.m + c2.m)</b></td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;"><b>(rel_c2vx_o * dx * dy + rel_c2vy_o * dy * dy) * (c2.m - c1.m) + (-rel_c2vx_o * dy * dx + rel_c2vy_o * dx * dx) * (c1.m + c2.m)</b></td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Expand the upper part of the fraction:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;"><b>rel_c2vx_o*dx*dx*c2.m+rel_c2vy_o*dx*dy*c2.m-rel_c2vx_o*dx*dx*c1.m-rel_c2vy_o*dx*dy*c1.m+rel_c2vx_o*dy*dy*c2.m-rel_c2vy_o*dx*dy*c2.m+rel_c2vx_o*dy*dy*c1.m-rel_c2vy_o*dx*dy*c1.m</b></td>
              <td rowspan="2"> - rel_c2vx_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;"><b>rel_c2vx_o*dx*dy*c2.m+rel_c2vy_o*dy*dy*c2.m-rel_c2vx_o*dx*dy*c1.m-rel_c2vy_o*dy*dy*c1.m+rel_c2vy_o*dx*dx*c2.m-rel_c2vx_o*dx*dy*c2.m+rel_c2vy_o*dx*dx*c1.m-rel_c2vx_o*dx*dy*c1.m</b></td>
              <td rowspan="2"> - rel_c2vy_o</td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Simplify the upper part of the fraction:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o*dx*dx*c2.m-rel_c2vx_o*dx*dx*c1.m+rel_c2vx_o*dy*dy*c2.m+rel_c2vx_o*dy*dy*c1.m-2*rel_c2vy_o*dx*dy*c1.m</td>
              <td rowspan="2"> - <b>rel_c2vx_o</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;">rel_c2vy_o*dy*dy*c2.m-rel_c2vy_o*dy*dy*c1.m+rel_c2vy_o*dx*dx*c2.m+rel_c2vy_o*dx*dx*c1.m-2*rel_c2vx_o*dx*dy*c1.m</td>
              <td rowspan="2"> - <b>rel_c2vy_o</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Now we furthur simplify the formulae by grouping <code>rel_c2vx_o</code> , <code>rel_c2vy_o</code> and the fraction before together:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;">rel_c2vx_o*dx*dx*c2.m-rel_c2vx_o*dx*dx*c1.m+rel_c2vx_o*dy*dy*c2.m+rel_c2vx_o*dy*dy*c1.m-2*rel_c2vy_o*dx*dy*c1.m</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;"><b>o_rel_vx * (dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
              <td><b>(dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;">rel_c2vy_o*dy*dy*c2.m-rel_c2vy_o*dy*dy*c1.m+rel_c2vy_o*dx*dx*c2.m+rel_c2vy_o*dx*dx*c1.m-2*rel_c2vx_o*dx*dy*c1.m</td>
              <td rowspan="2"> - </td>
              <td style="border-bottom:1px solid;"><b>o_rel_vy * (dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
              <td><b>(dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Again, combine the fractions:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;"><b>rel_c2vx_o*dx*dx*c2.m-rel_c2vx_o*dx*dx*c1.m+rel_c2vx_o*dy*dy*c2.m+rel_c2vx_o*dy*dy*c1.m-2*rel_c2vy_o*dx*dy*c1.m-rel_c2vx_o*dx*dx*c2.m-rel_c2vx_o*dy*dy*c2.m-rel_c2vx_o*dx*dx*c1.m-rel_c2vx_o*dy*dy*c1.m</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;"><b>rel_c2vy_o*dy*dy*c2.m-rel_c2vy_o*dy*dy*c1.m+rel_c2vy_o*dx*dx*c2.m+rel_c2vy_o*dx*dx*c1.m-2*rel_c2vx_o*dx*dy*c1.m-rel_c2vy_o*dx*dx*c2.m-rel_c2vy_o*dy*dy*c2.m-rel_c2vy_o*dx*dx*c1.m-rel_c2vy_o*dy*dy*c1.m</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Simplify the formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx + </td>
              <td style="border-bottom:1px solid;"><b>-2*rel_c2vy_o*dx*dy*c1.m-2*rel_c2vx_o*dx*dx*c1.m</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy + </td>
              <td style="border-bottom:1px solid;"><b>-2*rel_c2vx_o*dx*dy*c1.m-2*rel_c2vy_o*dy*dy*c1.m</b></td>
            </tr>
            <tr>
              <td>(dx * dx + dy * dy) * (c1.m + c2.m)</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>Rewrite the formulae:</p>
    <table border="1" style="margin-left:auto;margin-right:auto;">
      <th>Circle 2 (C2):</th>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vx = c2.vx - </td>
              <td style="border-bottom:1px solid;"><b>2 * dx * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy)</b></td>
            </tr>
            <tr>
              <td><b>(dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table style="margin-left:auto;margin-right:auto;text-align:center;">
            <tr>
              <td rowspan="2">c2.vy = c2.vy - </td>
              <td style="border-bottom:1px solid;"><b>2 * dy * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy)</b></td>
            </tr>
            <tr>
              <td><b>(dx * dx + dy * dy) * (c1.m + c2.m)</b></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    <p>The code of formulae of circle 1 (C1) becomes:</p>
    <div class="codeParentDiv" style="height:6em"><div class="hljs readborder" style="position:absolute;">   
      <pre><code><span class="hl">c2.vx -= 2 * dx * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
c2.vy -= 2 * dy * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);</span></code></pre>
    </div></div>
    <p>Now the collision detection and response code changed to the following:</p>
    <div class="codeParentDiv" style="height:20em"><div class="hljs readborder" style="position:absolute;">   
    <pre><code><span class="hl">.
.
.
if(dx * dx + dy * dy <= (c1.r + c2.r)*(c1.r + c2.r)){ //find if d is smaller than (or equals to) r1+r2
  const rel_c2vx_o = c2.vx - c1.vx;
  const rel_c2vy_o = c2.vy - c1.vy;
  if(rel_c2vx_o * dx + rel_c2vy_o * dy < 0){ //apply collision only when 2 circles are colliding instead of separating
    c1.vx += 2 * dx * c2.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c1.vy += 2 * dy * c2.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c2.vx -= 2 * dx * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c2.vy -= 2 * dy * c1.m * (rel_c2vx_o * dx + rel_c2vy_o * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
  }
}
.
.
.</span></code></pre>
    </div></div>
    <p>Now no more variables have '_n' suffix and only <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> with '_o' suffix, we may change <code>rel_c2vx_o</code> and <code>rel_c2vy_o</code> into <code>rel_c2vx</code> and <code>rel_c2vy</code> in order to have shorter variable names:</p>
    <p>Now the collision detection and response code changed to the following:</p>
    <div class="codeParentDiv" style="height:20em"><div class="hljs readborder" style="position:absolute;">   
    <pre><code><span class="hl">.
.
.
if(dx * dx + dy * dy <= (c1.r + c2.r)*(c1.r + c2.r)){ //find if d is smaller than (or equals to) r1+r2
  const rel_c2vx = c2.vx - c1.vx;
  const rel_c2vy = c2.vy - c1.vy;
  if(rel_c2vx * dx + rel_c2vy * dy < 0){ //apply collision only when 2 circles are colliding instead of separating
    c1.vx += 2 * dx * c2.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c1.vy += 2 * dy * c2.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c2.vx -= 2 * dx * c1.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
    c2.vy -= 2 * dy * c1.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
  }
}
.
.
.</span></code></pre>
    </div></div>
    <p>Finally, we may put the code into the canvas:</p>
    <div class="codeParentDiv" style="height:106em"><div class="hljs copyborder" style="position:absolute;">   
        <pre><code><span class="hl">&lt;canvas id=&quot;myCanvas&quot; width=&quot;400px&quot; height=&quot;400px&quot;&gt&lt/canvas&gt;
&lt;script&gt;</span>
<span class="hl">  const c1={
    cx:-45,
    cy:-75,
    r:50,
    m:Math.PI*50*50, //mass = area
    vx:15,
    vy:30
  };

  const c2={
    cx:135,
    cy:-90,
    r:30,
    m:Math.PI*30*30, //mass = area
    vx:-45,
    vy:60
  };

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");
  ctx.font="12px sans-serif";
  ctx.textAlign="center";
  const frameRate=60;

  setInterval(function(){
    //circle position update
    c1.cx+=c1.vx*1/frameRate;
    c1.cy+=c1.vy*1/frameRate;
    c2.cx+=c2.vx*1/frameRate;
    c2.cy+=c2.vy*1/frameRate;

    //circle check collision : find if d is smaller than (or equals to) r1+r2
    const dx=c2.cx-c1.cx;
    const dy=c2.cy-c1.cy;
    if(dx * dx + dy * dy <= (c1.r + c2.r)*(c1.r + c2.r)){ //find if d is smaller than (or equals to) r1+r2
      const rel_c2vx = c2.vx - c1.vx;
      const rel_c2vy = c2.vy - c1.vy;
      if(rel_c2vx * dx + rel_c2vy * dy < 0){ //apply collision only when 2 circles are colliding instead of separating
        c1.vx += 2 * dx * c2.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
        c1.vy += 2 * dy * c2.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
        c2.vx -= 2 * dx * c1.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
        c2.vy -= 2 * dy * c1.m * (rel_c2vx * dx + rel_c2vy * dy) / (dx * dx + dy * dy) / (c1.m + c2.m);
      }
    }

    //clear all drawings
    ctx.clearRect(0,0,canvas.width,canvas.height);

    //draw x and y axis
    ctx.strokeStyle="lightgray";
    ctx.beginPath();
    ctx.moveTo(0,canvas.height/2);
    ctx.lineTo(canvas.width,canvas.height/2);
    ctx.moveTo(canvas.width/2,0);
    ctx.lineTo(canvas.width/2,canvas.height);
    ctx.stroke();
    ctx.strokeStyle="black";

    //draw border
    ctx.beginPath();
    ctx.rect(0,0,canvas.width,canvas.height);
    ctx.stroke();

    //draw circle
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,c1.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c1.cx.toFixed(1)+","+c1.cy.toFixed(1),canvas.width/2+c1.cx,canvas.height/2-c1.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.lineTo(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c1.vx.toFixed(1)+","+c1.vy.toFixed(1),canvas.width/2+c1.cx+c1.vx,canvas.height/2-c1.cy-c1.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C1",canvas.width/2+c1.cx,canvas.height/2-c1.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c1.cx,canvas.height/2-c1.cy,2,0,2*Math.PI);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,c2.r,0,2*Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillText(c2.cx.toFixed(1)+","+c2.cy.toFixed(1),canvas.width/2+c2.cx,canvas.height/2-c2.cy+16);
    ctx.fillStyle=ctx.strokeStyle="blue";
    ctx.moveTo(canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.lineTo(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy,2,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(c2.vx.toFixed(1)+","+c2.vy.toFixed(1),canvas.width/2+c2.cx+c2.vx,canvas.height/2-c2.cy-c2.vy-4);
    ctx.fillStyle=ctx.strokeStyle="gray";
    ctx.fillText("C2",canvas.width/2+c2.cx,canvas.height/2-c2.cy);
    ctx.fillStyle=ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.arc(canvas.width/2+c2.cx,canvas.height/2-c2.cy,2,0,2*Math.PI);
    ctx.fill();
  },1000/frameRate);</span>
<span class="hl">&lt/script&gt</span></code></pre>
        <div class="dimdiv">
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>      
          <code class="showcode">&nbsp;</code>  
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="showcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>        
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>          
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code> 
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>  
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>   
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
          <code class="dimcode">&nbsp;</code>
        </div>
     </div></div>
    <p>The canvas should look the same as before elimiating the square root:</p>
    <iframe id="iframe-chapter_5_10_1-1" class="center" src="chapter_5_10_1.html" width="400px" height="400px" frameBorder="0" marginheight="0" marginwidth="0"></iframe>
    <br/><button class="center" onclick="document.getElementById('iframe-chapter_5_10_1-1').src+='';">Reload</button>
    <p>Congratulations again! You finished the core part of the physics engine : collision detection and handling! There are other additional functions to add to the canvas at the comming chapters, but it is relatively simple and can be easily implemented!</p>
        </div></td>
      </tr>
    </table>
  </body>
  <script src="highlight/highlight.min.js"></script>
  <script>
  document.querySelectorAll('.hl').forEach(el => {
    hljs.highlightElement(el);
  });
  </script>
</html>
